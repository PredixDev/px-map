<link rel="import" href="../polymer/polymer.html"/>
<link rel="import" href="px-map-behavior-tile-layer.html"/>

<!--
This subcomponent displays WMTS services as tile layers on the map. It is based on
the `leaflet.TileLayer.WMTS` [plugin](https://github.com/mylen/leaflet.TileLayer.WMTS)
released by Alexandre Melard on Github under the [BSD license](https://github.com/mylen/leaflet.TileLayer.WMTS/blob/982070cf5521dad7d00cd790a5c02c01eed26f3d/LICENCE).

### Usage

    <px-map>
      <px-map-tile-layer-wmts 
        url="http://example.com/cgi-bin/wmts/map.cgi" 
        layer="WorldTimeZones" 
        format="image/jpeg" 
        attribution="Example data (c) 2017 Example Corp."> 
      </px-map-tile-layer-wmts>
    </px-map>

@element px-map-tile-layer-wmts
@blurb Displays WMTS services as tile layers
@homepage index.html
@demo index.html
-->

<script src="leaflet-tilelayer-wmts.js"></script>

<dom-module id="px-map-tile-layer-wmts">
  <style>
    :host { display: none }
  </style>
  <template></template>
</dom-module>

<script>
  Polymer({
    is: 'px-map-tile-layer-wmts',
    behaviors: [PxMapBehavior.Layer],

    properties: {
      /**
       * Base URL of the WMTS service.
       */
      url: {
        type: String,
        observer: 'shouldUpdateInst'
      },

      /**
       * WMTS layer to show the WMTS tiles.
       */
      layer: {
        type: String,
        observer: 'shouldUpdateInst'
      },

      /**
       * Comma-separated list of WMTS styles.
       */
      style: {
        type: String,
        observer: 'shouldUpdateInst',
        value: 'default'
      },

      /**
       * WMTS image format to use (use 'image/png' for layers).
       */
      format: {
        type: String,
        value: 'image/jpeg',
        observer: 'shouldUpdateInst'
      },

      /**
       * Version of the WMTS service to use.
       */
      version: {
        type: String,
        value: '1.0.0',
        observer: 'shouldUpdateInst'
      },

      /**
       * Transparent property of wmts layer.
       */
      disableTransparent: {
        type: Boolean,
        value: false,
        observer: 'shouldUpdateInst'
      },

      /**
       * Tile matrix set to use for the WMTS requests, defaults to
       * map 'default'. Don't change this if you're not sure what it means.
       */
      tileMatrixSet: {
        type: String,
        value: 'default',
        observer: 'shouldUpdateInst'
      }
    },

    canAddInst: function() {
      return (typeof this.url === 'string') && this.url.length > 0 && (typeof this.layer === 'string') && this.layer.length > 0;
    },

    createInst: function(options) {
      return L.tileLayer.wmts(options.url, options.wmtsOptions);
    },

    updateInst: function(lastOptions, nextOptions) {
      if (lastOptions.wmtsOptionsHash !== nextOptions.wmtsOptionsHash) {
        this.elementInst.setParams(nextOptions.wmtsOptions);
      }
    },

    getInstOptions: function() {
      const wmtsOptions = {
        layer: this.layer,
        version: this.version
      };
      if (typeof this.style === 'string' && this.style.length > 0) {
        wmtsOptions.style = this.style;
      }
      if (typeof this.format === 'string' && this.format.length > 0) {
        wmtsOptions.format = this.format;
      }
      if (this.tileMatrixSet) {
        wmtsOptions.tileMatrixSet = this.tileMatrixSet;
      }

      // assign the transparent property
      this.disableTransparent = true;
      wmtsOptions.transparent = this.disableTransparent;

      return {
        url: this.url,
        wmtsOptions: wmtsOptions,
        wmtsOptionsHash: JSON.stringify(wmtsOptions)
      };
    }
  });
</script>
